<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ë§¤ì¥ ì˜ˆì•½ ì„œë¹„ìŠ¤</title>
    <link rel="stylesheet" href="/webjars/leaflet/1.9.4/dist/leaflet.css"/>
    <!-- Bootstrap CSS (ëª¨ë‹¬ ë° ìŠ¤íƒ€ì¼ìš©, í•„ìš”ì‹œ ì¶”ê°€) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <th:block th:replace="~{header/header :: header-css}"></th:block>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Pretendard', sans-serif; }
        #map { width: 100%; height: 100vh; z-index: 1; }

        /* ì§€ë„ ìœ„ í”Œë¡œíŒ… ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .map-overlay-btn {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }
        .map-overlay-btn:hover { background-color: #0056b3; }

        /* ì»¤ìŠ¤í…€ íŒì—… ìŠ¤íƒ€ì¼ */
        .store-popup .store-name { font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; }
        .store-popup .store-desc { font-size: 0.9rem; color: #666; margin-bottom: 10px; }
        .store-popup .btn-reserve { width: 100%; }
    </style>
</head>
<body>
<div th:replace="~{header/header :: main-header}"></div>

<!-- ì§€ë„ ì˜ì—­ -->
<div id="map"></div>

<!-- í˜„ ìœ„ì¹˜ì—ì„œ ë§¤ì¥ ì°¾ê¸° ë²„íŠ¼ -->
<button class="map-overlay-btn" onclick="searchStoresInCurrentView()">í˜„ ìœ„ì¹˜ì—ì„œ ë§¤ì¥ ì°¾ê¸°</button>

<!-- ì˜ˆì•½ ëª¨ë‹¬ (Bootstrap Modal) -->
<div class="modal fade" id="reservationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ë§¤ì¥ ì˜ˆì•½</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modalStoreId">
                <div class="mb-3">
                    <label class="form-label fw-bold" id="modalStoreName">ê°€ê²Œ ì´ë¦„</label>
                </div>
                <div class="mb-3">
                    <label for="visitorCount" class="form-label">ë°©ë¬¸ ì¸ì›</label>
                    <input type="number" class="form-control" id="visitorCount" value="2" min="1">
                </div>
                <div class="mb-3">
                    <label for="reservedAt" class="form-label">ì˜ˆì•½ ì‹œê°„</label>
                    <input type="datetime-local" class="form-control" id="reservedAt" step="1800">
                </div>
                <div class="mb-3">
                    <label for="finishedAt" class="form-label">ì¢…ë£Œ ì‹œê°„ (ì˜ˆìƒ)</label>
                    <input type="datetime-local" class="form-control" id="finishedAt" step="1800">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="submitReservation()">ì˜ˆì•½í•˜ê¸°</button>
            </div>
        </div>
    </div>
</div>

<script src="/webjars/leaflet/1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // 1. ì§€ë„ ì´ˆê¸°í™”
    var map = L.map('map', { zoomControl: false }).setView([37.5665, 126.9780], 13);
    L.control.zoom({ position: 'bottomright' }).addTo(map);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    var markers = []; // ë§ˆì»¤ ê´€ë¦¬ìš© ë°°ì—´
    var reservationModal = new bootstrap.Modal(document.getElementById('reservationModal'));

    // 2. í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° ë° ì´ˆê¸° ë¡œë”©
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            // ì§€ë„ ì´ë™
            map.setView([lat, lng], 15);

            // ë‚´ ìœ„ì¹˜ ë§ˆì»¤ (íŒŒë€ìƒ‰ ì›)
            L.circleMarker([lat, lng], {
                radius: 8,
                fillColor: "#3388ff",
                color: "#fff",
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map).bindPopup("í˜„ì¬ ë‚´ ìœ„ì¹˜");

            // ì´ˆê¸° ë§¤ì¥ ë¡œë”©
            loadStores(lat, lng);

        }, function(error) {
            console.error("ìœ„ì¹˜ ì •ë³´ ì‹¤íŒ¨: ", error.message);
            // ìœ„ì¹˜ ê¶Œí•œ ì—†ìœ¼ë©´ ì„œìš¸ ì‹œì²­ ê¸°ì¤€ìœ¼ë¡œ ë¡œë“œ
            loadStores(37.5665, 126.9780);
        }, { enableHighAccuracy: true });
    } else {
        loadStores(37.5665, 126.9780);
    }

    // 3. ë§¤ì¥ ê²€ìƒ‰ í•¨ìˆ˜ (Backend API í˜¸ì¶œ)
    function loadStores(lat, lng) {
        // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];

        // API í˜¸ì¶œ íŒŒë¼ë¯¸í„° êµ¬ì„± (LocationRequest DTOì— ë§ì¶¤)
        const params = new URLSearchParams({
            latitude: lat,
            longitude: lng,
            radius: 1000.0 // ë°˜ê²½ 1km (í•„ìš”ì‹œ ì¡°ì •)
        });

        fetch(`/store/storeList?${params.toString()}`)
            .then(response => {
                if (!response.ok) throw new Error("ë§¤ì¥ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                return response.json();
            })
            .then(data => {
                data.forEach(store => {
                    addStoreMarker(store);
                });
            })
            .catch(error => console.error("Error:", error));
    }

    // 4. ì§€ë„ì— ë§¤ì¥ ë§ˆì»¤ ì¶”ê°€
    function addStoreMarker(store) {
        // ë°±ì—”ë“œ StoreResponse DTO í•„ë“œëª…(latitude, longitude)ê³¼ ë§ì¶¤
        const lat = store.latitude;
        const lng = store.longitude;

        // ë°ì´í„°ê°€ ì •ìƒì ìœ¼ë¡œ ë“¤ì–´ì™”ëŠ”ì§€ í™•ì¸
        if (!lat || !lng) {
            console.warn(`${store.name} ë§¤ì¥ì˜ ì¢Œí‘œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.`);
            return;
        }

        var marker = L.marker([lat, lng]).addTo(map);

        const popupContent = `
        <div class="store-popup">
            <div class="store-name">${store.name}</div>
            <div class="store-desc">${store.description || 'ì„¤ëª… ì—†ìŒ'}</div>
            <div style="font-size:0.8rem; margin-bottom:5px;">ğŸ“ ${store.address || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ'}</div>
            <button class="btn btn-sm btn-primary btn-reserve"
                onclick="openReservationModal(${store.id}, '${store.name}')">
                ì˜ˆì•½í•˜ê¸°
            </button>
        </div>
    `;

        marker.bindPopup(popupContent);
        markers.push(marker);
    }

    // 5. "í˜„ ìœ„ì¹˜ì—ì„œ ë§¤ì¥ ì°¾ê¸°" ë²„íŠ¼ ë™ì‘
    function searchStoresInCurrentView() {
        const center = map.getCenter();
        loadStores(center.lat, center.lng);
    }

    // 6. ì˜ˆì•½ ëª¨ë‹¬ ì—´ê¸°
    window.openReservationModal = function(storeId, storeName) {
        document.getElementById('modalStoreId').value = storeId;
        document.getElementById('modalStoreName').innerText = storeName;

        const now = new Date();
        const minutes = now.getMinutes();

        if (minutes > 0 && minutes <= 30) {
            now.setMinutes(30, 0, 0);
        } else if (minutes > 30) {
            now.setHours(now.getHours() + 1);
            now.setMinutes(0, 0, 0);
        } else {
            now.setMinutes(0, 0, 0);
        }

        // ISO í˜•ì‹ìœ¼ë¡œ ë³€í™˜ í•¨ìˆ˜ (ë¡œì»¬ ì‹œê°„ ê¸°ì¤€)
        const toLocalISOString = (date) => {
            const offset = date.getTimezoneOffset() * 60000;
            const localISOTime = (new Date(date - offset)).toISOString().slice(0, 16);
            return localISOTime;
        };

        // ì‹œì‘ ì‹œê°„ ì„¤ì • (í˜„ì¬ ì‹œê°„ ê¸°ì¤€ ê°€ì¥ ê°€ê¹Œìš´ 30ë¶„/ì •ì‹œ)
        const startTimeStr = toLocalISOString(now);
        document.getElementById('reservedAt').value = startTimeStr;

        // ì¢…ë£Œ ì‹œê°„ ì„¤ì • (ì‹œì‘ ì‹œê°„ìœ¼ë¡œë¶€í„° 1ì‹œê°„ ë’¤)
        now.setHours(now.getHours() + 1);
        const endTimeStr = toLocalISOString(now);
        document.getElementById('finishedAt').value = endTimeStr;

        reservationModal.show();
    }

    // 7. ì˜ˆì•½ ìš”ì²­ ì „ì†¡ (Backend API í˜¸ì¶œ)
    window.submitReservation = function() {
        const storeId = document.getElementById('modalStoreId').value;
        const visitorCount = document.getElementById('visitorCount').value;
        const reservedAt = document.getElementById('reservedAt').value;
        const finishedAt = document.getElementById('finishedAt').value;

        const requestData = {
            storeId: parseInt(storeId),
            visitorCount: parseInt(visitorCount),
            reservedAt: reservedAt,
            finishedAt: finishedAt
        };

        fetch('/reservation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // JWT í† í°ì´ í•„ìš”í•˜ë‹¤ë©´ ì—¬ê¸°ì— Authorization í—¤ë” ì¶”ê°€
                 'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
            },
            body: JSON.stringify(requestData)
        })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    return response.json().then(err => { throw new Error(err.message || 'ì˜ˆì•½ ì‹¤íŒ¨'); });
                }
            })
            .then(data => {
                alert('ì˜ˆì•½ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                reservationModal.hide();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ì˜ˆì•½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                // ë¡œê·¸ì¸ ì•ˆëœ ê²½ìš° ì²˜ë¦¬ (ì˜ˆ: 403 Forbidden)
                if(error.message.includes('ê¶Œí•œ') || error.message.includes('ë¡œê·¸ì¸')) {
                    location.href = '/login'; // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                }
            });
    }
</script>

<th:block th:replace="~{header/header :: header-js}"></th:block>
</body>
</html>